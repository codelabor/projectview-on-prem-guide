# 백업

## 백업 소스 
백업할 내용과 방법은 다음과 같다.

* 애플리케이션: 설치 파일을 직접 보관
* 데이터베이스: 백업 스크립트를 실행 (3일 보관)
* 첨부파일: 백업 스크립트를 실행 (3일 보관)

## 백업 타겟
백업이 보관될 타겟을 정한다.
필요에 따라 백업 스토리지를 마운트할 수 있다.

* 애플리케이션: 임의의 장소에 직접 보관 
* 데이터베이스: 백업 스크립트에서 설정된 타겟 디렉토리
* 첨부파일: 백업 스크립트에서 설정된 타겟 디렉토리

### 백업 경로 생성
**Warning**
백업 경로를 정의한 후 해당 경로를 잊지 않도록 메모한다.

아래 경로를 백업 타겟 디렉토리라고 가정한다.
* /backup/projectview

백업 타겟 디렉토리를 생성하고 소유권을 설정한다.

```
projectview@projectview:~$ sudo mkdir -p /backup/projectview
projectview@projectview:/$ sudo chown -R projectview:projectview /backup
```

## 백업 스크립트 수정

설치 디렉토리에서 백업 스크립트를 확인한다.
* 스크립트 파일명: shutdown-projectview.sh 

```
rojectview@projectview:~$ cd /app/projectview
projectview@projectview:/app/projectview$ ls
backup-projectview.sh  cert  conf  config.env  docker-compose.yml  logs  postgresql  shutdown-projectview.sh  startup-projectview.sh  uploadFiles
```

백업 스크립트에서 백업 타겟 디렉토리를 수정한다.
```
rojectview@projectview:/app/projectview$ vi backup-projectview.sh 
```

수정할 내용은 아래와 같다.

* 수정 전: BACKUP_PATH=/projectview-backup
* 수정 후: BACKUP_PATH=/backup/projectview

## 백업 실행
백업 스크립트를 실행한다.

```
projectview@projectview:/app/projectview$ ./backup-projectview.sh 
```

백업 결과를 확인한다.
백업 날짜 디렉토리 아래에 아래 형식의 파일 2개가 생성된 걸 확인한다.

* 데이터베이스 백업: projectview-날짜.dat
* 첨부파일 백업: projectview-attach-backup-날짜.tar.gz

```
projectview@projectview:/app/projectview$ cd /backup/projectview
projectview@projectview:/backup/projectview$ ls
20240418
projectview@projectview:/backup/projectview$ cd 20240418
projectview@projectview:/backup/projectview/20240418$ ls
projectview-20240418.dat  projectview-attach-backup-20240418.tar.gz
```

## 자동 백업 설정
자동으로 실행되도록 crontab을 설정한다.
crontab 설정 패턴은 아래와 같다.

```
┌───────────── minute (0–59)
│ ┌───────────── hour (0–23)
│ │ ┌───────────── day of the month (1–31)
│ │ │ ┌───────────── month (1–12)
│ │ │ │ ┌───────────── day of the week (0–6) (Sunday to Saturday;
│ │ │ │ │                                   7 is also Sunday on some systems)
│ │ │ │ │
│ │ │ │ │
* * * * * <command to execute>
```
출처: [https://en.wikipedia.org/wiki/Cron#CRON_expression](https://en.wikipedia.org/wiki/Cron#CRON_expression)

crontab 편집 명령을 실행한다.
편집기는 자신에게 익숙한 걸 선택한다.

```
projectview@projectview:~$ crontab -e
no crontab for projectview - using an empty one

Select an editor.  To change later, run 'select-editor'.
  1. /bin/nano        <---- easiest
  2. /usr/bin/vim.tiny
  3. /usr/bin/code
  4. /bin/ed

Choose 1-4 [1]: 
```

매일 1시에 백업한다고 가정할 때 아래 내용을 추가한다.

```
# m h dom mon dow command
0 1 * * * /app/projectview/backup-projectview.sh
```

# 복원

## 복원 소스 
복원할 내용은 다음과 같다.

* 애플리케이션: 직접 보관한 설치 파일
* 데이터베이스: 백업 디렉토리의 덤프 파일
* 첨부파일: 백업 디렉토리의 아카이브 파일

복원 소스의 디렉토리와 파일명은 아래 이름으로 가정한다.

```
rojectview@projectview:/backup/projectview/20240418$ ls
projectview-20240418.dat  projectview-attach-backup-20240418.tar.gz
```
 
## 데이터베이스 복원 방법
백업 파일을 도커 컨테이너 pms-postgresql 안으로 복사한다.
```
projectview@projectview:~$ docker cp /backup/projectview/20240418/projectview-20240418.dat pms-postgresql:/projectview-20240418.dat
Successfully copied 9.53MB to pms-postgresql:/projectview-20240418.dat
```

도커 컨테이너 pms-postgresql의 터미널로 들어간다.
```
projectview@projectview:~$ docker exec -it pms-postgresql /bin/bash
root@ec614314a658:/#
```

psql 명령을 실행한다.
```
root@ec614314a658:/# psql -p 35432 -d promise
psql (13.13 (Debian 13.13-1.pgdg120+1))
Type "help" for help.

promise=# 
```

public 스키마를 삭제하고 다시 생성한다.
```
promise=# DROP SCHEMA public CASCADE;
NOTICE:  drop cascades to 198 other objects
DETAIL:  drop cascades to table databasechangelog
drop cascades to table databasechangeloglock
drop cascades to table t_clb_annm_noticobj_m
drop cascades to table t_clb_bbs_appr_rsp_usr_r
drop cascades to table t_clb_bbs_catg_grp_d
drop cascades to table t_clb_bbs_catg_grp_m
drop cascades to table t_clb_bbs_log_h
drop cascades to table t_clb_bbs_m
drop cascades to table t_clb_faq_noticobj_m
drop cascades to table t_clb_noticobj_ans_d
drop cascades to table t_clb_qna_noticobj_ans_d
drop cascades to table t_clb_qna_noticobj_m
drop cascades to table t_clb_usr_scrap_d
drop cascades to table t_cma_auth_appr_dlgtn_d
drop cascades to table t_cma_auth_appr_h
drop cascades to table t_cma_auth_rqs_m
drop cascades to table t_cma_role_m
drop cascades to table t_cma_role_obj_r
drop cascades to table t_cma_role_obj_r_template
drop cascades to table t_cma_role_usr_r
drop cascades to table t_cma_usr_grp_m
drop cascades to table t_cma_usr_grp_usr_r
drop cascades to table t_cmd_atth_exld_rsn_d
drop cascades to table t_cmd_atth_file_d
drop cascades to table t_cmd_atth_file_dload_h
drop cascades to table t_cmd_atth_grp_m
drop cascades to table t_cmd_atth_item_d
drop cascades to table t_psz_app_statistics
drop cascades to table t_psz_column_info
drop cascades to table t_psz_comment
drop cascades to table t_psz_file
drop cascades to table t_psz_inquiry_history
drop cascades to table t_psz_meeting_room
drop cascades to table t_psz_milestone
drop cascades to table t_psz_openqa_history
drop cascades to table t_psz_personal_work_category
drop cascades to table t_psz_privacy_history
drop cascades to table t_psz_project
drop cascades to table t_psz_project_invitation
drop cascades to table t_psz_project_openqa
drop cascades to table t_psz_project_user_relation
drop cascades to table t_psz_release_note
drop cascades to table t_psz_system_notice
drop cascades to table t_psz_tenant
drop cascades to table t_psz_user_personal_setting
drop cascades to table t_psz_work_category
drop cascades to table t_cmp_app_m
drop cascades to table t_cmp_app_m_template
drop cascades to table t_cmp_menu_m
drop cascades to table t_cmp_menu_wrk_m
drop cascades to table t_cmp_menu_wrk_m_template
drop cascades to table t_cmp_portl_m
drop cascades to table t_cmp_usr_aco_m
drop cascades to table t_cmp_usr_appl_h
drop cascades to table t_cmp_usr_login_log_h
drop cascades to table t_cmt_tab_m
drop cascades to table t_cmu_cmpnt_dtsvc_r
drop cascades to table t_cmu_cmpnt_m
drop cascades to table t_cmu_cmpnt_msg_reso_r
drop cascades to table t_cmu_cmpnt_r
drop cascades to table t_cmu_dtsvc_log_h
drop cascades to table t_cmu_dtsvc_m
drop cascades to table t_cmu_msg_reso_m
drop cascades to table t_cmu_obj_col_d
drop cascades to table t_cmu_obj_m
drop cascades to table t_cmu_page_cmpnt_r
drop cascades to table t_cmu_page_dtsvc_r
drop cascades to table t_cmu_page_log_h
drop cascades to table t_cmu_page_m
drop cascades to table t_cmu_page_m_b
drop cascades to table t_cmu_page_msg_reso_r
drop cascades to table t_cmu_page_prmt_d
drop cascades to table t_cmu_page_stats_d
drop cascades to table t_cmu_tab_m
drop cascades to table t_cmy_calr_m
drop cascades to table t_cmy_dept_m
drop cascades to table t_cmy_lng_m
drop cascades to table t_cmy_task_m
drop cascades to table t_cmy_usr_m
drop cascades to table t_cmz_cd_d
drop cascades to table t_cmz_cd_d_template
drop cascades to table t_cmz_cd_m
drop cascades to table t_cmz_cd_m_template
drop cascades to table t_cmz_cnfg_d
drop cascades to table t_cmz_cnfg_m
drop cascades to table t_cmz_cnfg_m_template
drop cascades to table t_cmz_dual_z
drop cascades to table t_cmz_hldy_m
drop cascades to table t_cmz_mlng_d
drop cascades to table t_cmz_mlng_d_template
drop cascades to table t_pac_user_m
drop cascades to table t_psc_mattermost_team
drop cascades to table t_psc_mattermost_user
drop cascades to table t_psc_meeting_room_booking
drop cascades to table t_psc_schedule
drop cascades to table t_psc_schedule_calendar
drop cascades to table t_psc_schedule_calendar_template
drop cascades to table t_psc_schedule_detail
drop cascades to table t_psc_schedule_participant
drop cascades to table t_psd_user_m
and 98 other objects (see server log for list)
DROP SCHEMA
promise=# CREATE SCHEMA public;
CREATE SCHEMA
promise=# 
```

권한을 부여한다.
```
promise=# GRANT ALL ON SCHEMA public TO postgres;
GRANT
promise=# GRANT ALL ON SCHEMA public TO public;
GRANT
promise=# GRANT ALL ON SCHEMA public TO promise;
GRANT
promise=#
```

'\q'로 psql을 종료하고 'exit'로 컨테이너에서 나온다.

```
promise=# \q
root@ec614314a658:/# exit
exit
projectview@projectview:~$ 
```

## 첨부파일 복원 방법
기존 첨부파일 디렉토리를 삭제하고 다시 생성한다.

```
projectview@projectview:~$ rm -rf /app/projectview/uploadFiles
projectview@projectview:~$ mkdir -p /app/projectview/uploadFiles
```

백업 파일을 복원 디렉토리 안으로 복사한다.
```
projectview@projectview:~$ cp /backup/projectview/20240418/projectview-attach-backup-20240418.tar.gz /app/projectview/uploadFiles/
```

복원 디렉토리로 이동한 후 아카이브 파일을 해제한다.
```
projectview@projectview:~$ cd /app/projectview/uploadFiles/
projectview@projectview:/app/projectview/uploadFiles$ tar -xvzf *.tar.gz
./
./projectview-attach-backup-20240418.tar.gz
./xssPolicy.xml
```

아카이브 파일을 삭제하고 복원 결과를 확인한다.
```
projectview@projectview:/app/projectview/uploadFiles$ rm -f *.tar.gz
projectview@projectview:/app/projectview/uploadFiles$ ls
xssPolicy.xml
```

**Warning**
XSS 취약점 방어를 위해 아래 파일이 반드시 있어야 한다.
* xssPolicy.xml


